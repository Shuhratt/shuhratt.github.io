<!--Посмотрите код страницы и вывод в консоль браузера.-->

<script src="shri-async-hw.js"></script>
<script>
    const {
        AsyncArray,
        add,
        subtract,
        multiply,
        divide,
        mod,
        less,
        equal,
        lessOrEqual,
        sqrt
    } = Homework;

    function square(a,b,c, resultCallback) {
      if(!Number.isInteger(a) || !Number.isInteger(b) || !Number.isInteger(c) ) {
        console.error('Не числовые аргументы')
        return
      }

      const as = new AsyncArray();
      const asyncAddArgument = (arg) => {
          let maxTime = 10000 // максимальное время ожидания
          return new Promise((resolve, reject) => {
              as.push(arg, () => resolve(arg))
              setTimeout(() => {
                  reject(arg)
              }, maxTime)
          })
      }

      let argA = asyncAddArgument(a)
      let argB = asyncAddArgument(b)
      let argC = asyncAddArgument(c)

      let calcX = (operation, a, b, c, discriminant) => { // поиск x
        let resB = new Promise(((resolve) => multiply(b, -1, (res) => resolve(res)))) // –b
        let resSquare = new Promise(((resolve) => sqrt(discriminant, (res) => resolve(res)))); // √ D
        let resLastMember =  new Promise(((resolve) => multiply(2, a, (res) => resolve(res)))) // 2a

        return Promise.all([resB, resSquare, resLastMember])// ждем все расчеты
          .then(([resB, resSquare, resLastMember]) => {
              if(operation === '-') {
                  return (resB - resSquare) / resLastMember
              } else{
                  return (resB + resSquare) / resLastMember
              }
          }).catch(err => console.error(err))


        // add +, divide /

        // –b + √ D / 2a
      }

      Promise.all([argA, argB, argC])
      .then(([a, b, c]) => { // all arguments

        // подготовка значений для D
        let firstMember = new Promise(((resolve) => multiply(b, b, (res) => resolve(res))))
        let secondMember = new Promise(((resolve) => multiply(a, c, (res) => resolve(res))))
                           .then(value => new Promise(((resolve) => multiply(value, 4, (res) => resolve(res)))));

        // D = b^2 – 4ac

        Promise.all([firstMember, secondMember])
          .then(([f, s]) => { // разность
              return new Promise(((resolve) => subtract(f, s, (res) => resolve(res))))
          })
          .then(discriminant => { // работа с результатом
            const resLess = new Promise(((resolve) => less(discriminant, 0, (res) => resolve(res)))) // <
            const resEqual = new Promise(((resolve) => equal(discriminant, 0, (res) => resolve(res)))) // ==

            Promise.all([resLess, resEqual])// ждем оба сравнения
              .then(([resLess, resEqual ]) => {
                  // console.log(resLess, resEqual)

                  if (resLess) {

                      //return throw Error(``)
                  }

                  if (resEqual) {

                      // return resultCallback() или throw Error()
                  }

                  calcX('-', a, b, c, discriminant) //
                  calcX('+', a, b, c, discriminant) //

                  let x1 =  calcX('-', a, b, c, discriminant)
                  let x2 = calcX('+', a, b, c, discriminant)


                  resultCallback(x1, x2)
                  // resultCallback(res1, res2)



              }).catch(err => console.error(err, 3))
          }).catch(err => console.error(err, 2))
        }).catch(err => console.error(err, 1))
    }

    square(1, 1, -6, (x1, x2) => {
        console.log(`x1 = ${x1}, x2 = ${x2}`)
    })


    // const {
    //     AsyncArray,
    //     add,
    //     subtract,
    //     multiply,
    //     divide,
    //     mod,
    //     less,
    //     equal,
    //     lessOrEqual,
    //     sqrt
    // } = Homework;
    //
    // const a = new AsyncArray([1, 2, 3]);
    //
    // console.log('добавление элемента');
    // a.push(4, () => { 
    //     console.log('добавление элемента выполнено');
    //     a.print();
    // });
    // a.print();
    //
    // console.log('присваивание элемента по индексу');
    // a.set(2, 999, () => { 
    //     console.log('присваивание элемента по индексу выполнено');
    //     a.print();
    // });
    // a.print();
    //
    // console.log('получение элемента по индексу');
    // a.get(0, (result) => { 
    //     console.log('получение элемента по индексу выполнено');
    //     console.log('результат', result);
    //     a.print();
    // });
    // a.print();
    //
    // console.log('получение последнего элемента');
    // a.pop((result) => { 
    //     console.log('получение последнего элемента выполнено');
    //     console.log('результат', result);
    //     a.print();
    // });
    // a.print();
    //
    // console.log('получение длины массива');
    // a.length((result) => { 
    //     console.log('получение длины массива выполнено');
    //     console.log('результат', result);
    //     a.print();
    // });
    // a.print();
    //
    // console.log('сложение: 5 + 2');
    // add(5, 2, (result) => console.log('результат сложения', result));
    //
    // console.log('вычитание: 11 - 7');
    // subtract(11, 7, (result) => console.log('результат вычитания', result));
    //
    // console.log('умножение: 6 * 7');
    // multiply(6, 7, (result) => console.log('результат умножения', result));
    //
    // console.log('деление: 13 / 7');
    // divide(13, 7, (result) => console.log('результат деления', result));
    //
    // console.log('остаток от деления: 17 % 7');
    // mod(17, 7, (result) => console.log('получен остаток от деления', result));
    //
    // console.log('квадратный корень из 16');
    // sqrt(16, (result) => console.log('квадратный корень', result));
    //
    // console.log('операция МЕНЬШЕ: 5 < 3');
    // less(5, 3, (result) => console.log('результат операции МЕНЬШЕ', result));
    //
    // console.log('операция РАВНО: 1 == 1');
    // equal(1, 1, (result) => console.log('результат операции РАВНО', result));
    //
    // console.log('операция МЕНЬШЕ ИЛИ РАВНО: 12 <= 19');
    // lessOrEqual(12, 19, (result) => console.log('результат операции МЕНЬШЕ ИЛИ РАВНО', result));

</script>
